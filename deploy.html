<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Security-Policy" content="default-src 'self' http: https: ws: wss: 'unsafe-inline';">
<title>Rendered by Ensuite</title>
</head>
<body>
<style name="assets/fonts.css" type="text/css">/* inter-regular - latin */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  src: url('assets/fonts/inter-v8-latin-regular.eot'); /* IE9 Compat Modes */
  src: local(''),
       url('assets/fonts/inter-v8-latin-regular.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('assets/fonts/inter-v8-latin-regular.woff2') format('woff2'), /* Super Modern Browsers */
       url('assets/fonts/inter-v8-latin-regular.woff') format('woff'), /* Modern Browsers */
       url('assets/fonts/inter-v8-latin-regular.ttf') format('truetype'), /* Safari, Android, iOS */
       url('assets/fonts/inter-v8-latin-regular.svg#Inter') format('svg'); /* Legacy iOS */
}

/* inter-600 - latin */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 600;
  src: url('assets/fonts/inter-v8-latin-600.eot'); /* IE9 Compat Modes */
  src: local(''),
       url('assets/fonts/inter-v8-latin-600.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('assets/fonts/inter-v8-latin-600.woff2') format('woff2'), /* Super Modern Browsers */
       url('assets/fonts/inter-v8-latin-600.woff') format('woff'), /* Modern Browsers */
       url('assets/fonts/inter-v8-latin-600.ttf') format('truetype'), /* Safari, Android, iOS */
       url('assets/fonts/inter-v8-latin-600.svg#Inter') format('svg'); /* Legacy iOS */
}


</style>
<style name="ensuite/node_modules/highlight.js/styles/school-book.css" type="text/css">pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#3e5915;background:#f6f5b2}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#059}.hljs-subst{color:#3e5915}.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-bullet,.hljs-link,.hljs-section,.hljs-string,.hljs-symbol,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#2c009f}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#e60415}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-strong,.hljs-title,.hljs-type{font-weight:700}.hljs-emphasis{font-style:italic}</style>
<style name="assets/style.css" type="text/css">* { box-sizing: border-box; margin: 0; padding: 0; line-height: 1.5; }

body { color: #123; font-size: 16px; font-family: "Inter", sans-serif; }
body { background-color: #f0f0f0; background-image: url('assets/bg.svg'); background-repeat: repeat; }

body > header {
  text-align: center;
  max-width: 80rem;
  margin: 0 auto;
  padding: 2rem 2rem 1rem;
}
body > header { display: flex; flex-flow: row nowrap; justify-content: space-around; align-items: center; }
body > header .logo, .logo img { display: block; margin: 0; flex-shrink: 1; }
body > header .logo img { max-width: 16rem; max-height: 16rem; }
body > header .badges { margin-bottom: 1rem; }
body > header a.badge { display: inline-block; padding: 0.25rem 0.5rem; }

section { padding: 1em; }

footer { padding: 1em; }

a { text-decoration: none; }
a:hover { text-decoration: underline; }
a, a:focus, a:visited, a:active, a:hover { color: rgb(101, 179, 76) }

h1, h2, h3, h4 { font-weight: 600 }
h1 { font-size: 3em;     line-height: 3rem;   margin-bottom: 2rem;                     }
h2 { font-size: 1.75em;  line-height: 2rem;   margin-bottom: 1rem;   margin-top: 0;    }
h3 { font-size: 1.5rem;  line-height: 2rem;   margin-bottom: 1rem;                     }
h4 { font-size: 1.25em;  line-height: 1.5rem; margin-bottom: 0.5rem; margin-top: 2rem; }
h5 { font-size: 1.125em; line-height: 1.5rem; margin-bottom: 0.5rem; margin-top: 2rem; }

button, .button {
  display: inline-block;
  background: rgb(101, 179, 76);
  color: white;
  padding: 0 1em;
  margin: 1em 0;
  text-shadow: -1px -1px 0 black;
  box-shadow: 1px 1px 0 black;
}
a.button:focus, a.button:visited, a.button:active, a.button:hover {
  color: white;
}

th, td { text-align: left; vertical-align: top; }
th { padding-right: 5em }

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  flex-flow: row wrap;
  justify-content: center;
  max-width: 80rem;
  margin: 0 auto 3rem;
}

@media (max-width: 80rem) {
  .grid {
    display: flex;
    flex-flow: column nowrap;
  }
  .grid .feature {
    display: flex;
    flex-flow: row nowrap;
  }
  .grid .feature .links {
    flex-shrink: 0;
    width: 33%;
    margin: 0 0 0 2rem;
  }
  .table-of-contents {
    width: 1rem;
  }
}

@media (max-width: 48rem) {
  .grid .feature .links {
    width: 50%;
  }
}

.big-left { grid-column-start: 1; grid-column-end: 3; }
.big-center { grid-column-start: 2; grid-column-end: 4; }
.big-right { grid-column-start: 3; grid-column-end: 5; }
.big-all { grid-column-start: 1; grid-column-end: 5; }

.feature {
  padding: 1rem;
  margin: 1rem 0.5rem 0;
  border: 1px solid rgba(0,0,0,0.1);
  border-top-color: rgba(255,255,255,0.5);
  border-left-color: rgba(255,255,255,0.5);
  border-radius: 3px;
  box-shadow: 3px 3px 6px rgba(0,0,0,0.1);
  display: flex;
  flex-flow: column nowrap;
  background: #fff;
}

.feature .docs {
  font-weight: bold;
}

#features .feature {
  min-height: 10rem;
}

.left {
  text-align: left;
}
.center {
  text-align: center;
}

.feature .description {
  line-height: 1.5;
  font-size: 0.875rem;
}

code { font-size: 0.9375rem; }
code.inline, code.block { background: #0c5749; color: white; font-family: monospace; font-weight: bold; }
code.inline { display: inline-block; padding: 0.5rem 1rem; margin: 0 0.5rem; }
code.block {
  display: block;
  padding: 1rem;
  margin: 1rem auto;
  border-radius: 0.5rem;
  max-width: 40rem;
  line-height: 1rem;
}

.feature-logo {
  margin-bottom: 0.5rem;
  height:        5rem;
  width:         12rem;
  align-self:    center;
}

.tag {
  font-size: 0.8rem;
  background: #f5faf3;
  border: 1px solid #437733;
  color: #437733;
  display: inline-block;
  padding: 0.25rem 0.5rem;
  margin: 0.5rem 0 0;
  align-self: flex-start;
  border-radius: 3px;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.spacer {
  flex-grow:  1;
  min-height: 0.5rem;
}

pre, code {
  font-family: monospace;
}

p {
  line-height: 1.5rem;
  margin-top: 0;
  margin-bottom: 0.5rem;
}

svg.icon {
  width: 2rem;
  height: 2rem;
}
a > svg.icon {
  fill: rgb(101, 179, 76);
  width: 1.5rem;
  height: 1.5rem;
  line-height: 1rem;
  vertical-align: baseline;
  margin-right: 0.5rem;
  flex-shrink: 0;
}
.feature a.docs {
  display: flex;
  flex-flow: row nowrap;
  align-items: flex-start;
  font-weight: normal;
  text-decoration: none;
  padding: 0.5rem 0;
  cursor: default;
  color: #888;
}
.feature a.docs[href] {
  text-decoration: underline;
  color: rgb(67, 119, 51);
  cursor: pointer;
}

@keyframes hourglass {
  50%  { transform: rotateZ(0);      }
	100% { transform: rotateZ(180deg); }
}

svg.icon-todo {
  animation-name: hourglass;
  animation-duration: 3s;
  animation-delay: 1s;
  animation-iteration-count: infinite;
}

.links {
  display: flex;
  flex-flow: column nowrap;
}
.links > a {
  margin-right: 1rem;
  transition:
    padding-left 0.33s,
    margin-right 0.33s;
}
.links > a[href]:hover {
  padding-left: 0.5rem;
  margin-right: 0.5rem;
}
.feature pre {
  background: #eee;
  padding: 0.5rem;
  border-radius: 0.1rem;
  font-size: 0.875rem;
  font-weight: normal;
  margin-top: 1rem;
  color: #555;
}

/*.feature .links .icon { fill: #F46623 }*/

.feature.invert { background: rgb(67, 119, 51); color: white; }
.feature.invert * { color: white; fill: white; }
.feature.invert a.docs { color: white; }
.feature.invert a.docs[href] { text-decoration: underline; }

.feature.foss { background: #2e0056; color: white; }
.feature.foss * { color: white; fill:  white; }
.feature.foss a.docs { color: white; }

.icon-todo { fill: #aaa !important; }

#quick-start {
  text-align: center;
  flex-grow: 1;
}

.ensuite-md-rendered {
  /*background: white;*/
  /*display: block;*/
  /*max-width: 54rem;*/
  /*margin: 3rem auto 0 38%;*/
  /*padding: 3rem;*/
  /*box-shadow: 3px 3px 6px rgba(0,0,0,0.1)*/
  display: flex;
  flex-flow: row nowrap;
  justify-content: center;
}


.ensuite-md-content {
  background: white;
  padding:    5rem 3rem 2rem;
  box-shadow: 3px 3px 6px rgba(0,0,0,0.1);
  max-width:  54rem;
}

.ensuite-md-nav {}
.ensuite-md-nav ul { list-style: none; margin-top: 5rem; margin-right: 2rem; }
.ensuite-md-nav li a { display: inline-block; font-weight: bold; padding: 0.5rem 1rem; text-transform: uppercase; font-size: 0.9rem; line-height: 1rem }

.ensuite-md-toc {}
.ensuite-md-toc .table-of-contents { margin-top: 5rem; margin-left: 1rem; overflow: auto; }
.table-of-contents { overflow: auto }
.table-of-contents a { display: block; text-decoration: none; padding: 0.25rem 1.5rem 0.25rem }
.table-of-contents a:hover { text-decoration: underline 2px solid }
.table-of-contents li { margin: 0 0 }
.table-of-contents ul { font-weight: bold; margin-left: 0; list-style: none }
.table-of-contents ul ul { font-weight: normal; margin-left: 1em }


/*.ensuite-md-rendered .table-of-contents {*/
  /*position: fixed;*/
  /*top: 3rem;*/
  /*left: 0;*/
  /*bottom: 0;*/
  /*width: 38%;*/
  /*background: #476d3b;*/
  /*background: hsl(106 25% 25% / 1);*/
  /*color: white;*/
  /*padding: 1rem 0 2rem 1rem;*/
  /*border-right: 1px solid #888;*/
  /*display: flex;*/
  /*justify-content: flex-end;*/
/*}*/
.ensuite-md-rendered h2 { margin-top: 2.5rem; margin-bottom: 0.5rem; }
.ensuite-md-rendered h3 { margin-top: 1.5rem; margin-bottom: 0.5rem; }

ul { margin-left: 0; margin-bottom: 1em; }

p > code { font-weight: bold; color: #345 }
pre > code {
  display: block;
  border: 1px solid #888;
  padding: 0.5rem 1rem;
  margin-bottom: 1rem;
  background: rgba(255,255,255,0.5);
  box-shadow: 2px 2px 2px #888;
  overflow-x: auto;
  margin: 1rem -1rem;
}
pre > code.language-sh {
  background: #123;
  border-radius: 0;
  color: #fe0;
}
pre > code.language-typescript {
  background: #ffe;
  border-radius: 0.15rem;
}

.ensuite-md-header {
  z-index: 100;
  display: flex;
  flex-flow: row nowrap;
  justify-content: space-between;
  text-align: left;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 3rem;
  font-size: 1.5rem;
  line-height: 3rem;
  margin: 0;
  padding: 0 1rem;
  font-weight: bold;
  background: hsl(106 30% 33% / 1);
  color: white;
  width: 100%;
  max-width: 100%;
  font-weight: normal
}
.ensuite-md-separator {
  flex-grow: 1;
}
.ensuite-md-header a {
  color: white;
}
.ensuite-md-header .ensuite-md-title {
}
.ensuite-md-header .ensuite-md-link {
  font-size: 1rem;
  margin-left: 1rem;
}

.hljs-comment, .hljs-deletion, .hljs-meta, .hljs-quote {
  color: green;
}
.hljs.language-sh .hljs-built_in {
  color: inherit;
}
.hljs.language-sh .hljs-comment {
  color: tomato;
}

hr {
  margin: 1rem -1rem;
}
</style>
<header class="ensuite-md-header">
<a class="ensuite-md-title" href="/">The <strong>Fadroma</strong> Guide</a>
<div class="ensuite-md-separator"></div>
<a class="ensuite-md-link" href=/>Homepage</a>
<a class="ensuite-md-link" href=/guide.html>Documentation</a>
<a class="ensuite-md-link" href=https://github.com/hackbg/fadroma>Github</a>
<a class="ensuite-md-link" href=https://crates.io/search?q=fadroma>Crates.io</a>
<a class="ensuite-md-link" href=https://www.npmjs.com/search?q=fadroma>NPM</a>
<a class="ensuite-md-link" href=https://hack.bg/>Hack.bg</a>
</header>
<div class="ensuite-md-rendered">
<nav class="ensuite-md-nav"><ul>
<li><a class="ensuite-md-link" href=/guide.html>Getting started</a></li>
<li><a class="ensuite-md-link" href=/project.html>Projects</a></li>
<li><a class="ensuite-md-link" href=/agent.html>Agent API</a></li>
<li><a class="ensuite-md-link" href=/scrt.html>Secret Network</a></li>
<li><a class="ensuite-md-link" href=/dsl.html>Macro DSL</a></li>
<li><a class="ensuite-md-link" href=/build.html>Building</a></li>
<li><a class="ensuite-md-link" href=/upload.html>Uploading</a></li>
<li><a class="ensuite-md-link" href=/deploy.html>Deploy API</a></li>
<li><a class="ensuite-md-link" href=/factory.html>Factories</a></li>
<li><a class="ensuite-md-link" href=/devnet.html>Devnets</a></li>
<li><a class="ensuite-md-link" href=/mocknet.html>Mocknets</a></li>
</ul></nav>
<content class="ensuite-md-content"><div><p></div></p>
<h1 id="fadroma-deploy-api" tabindex="-1">Fadroma Deploy API</h1>
<p>The <strong>Deploy API</strong> revolves around the <code>Deployment</code> class,
the <code>Template</code> and <code>Contract</code> classes, and the associated
implementations of <code>Client</code>, <code>Builder</code>, <code>Uploader</code>, and <code>DeployStore</code>.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Deployment</span>, <span class="hljs-title class_">Template</span>, <span class="hljs-title class_">Contract</span>, <span class="hljs-title class_">Client</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@fadroma/agent&#x27;</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">deployment</span>: <span class="hljs-title class_">Deployment</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">template</span>:   <span class="hljs-title class_">Template</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">contract</span>:   <span class="hljs-title class_">Contract</span>
</code></pre>
<p>These classes are used for describing systems consisting of multiple smart contracts,
such as when deploying them from source. By defining such a system as one or more
subclasses of <code>Deployment</code>, Fadroma enables declarative, idempotent, and reproducible
smart contract deployments.</p>
<h2 id="deployment" tabindex="-1">Deployment</h2>
<p>The <code>Deployment</code> class represents a set of interrelated contracts.
To define your deployment, extend the <code>Deployment</code> class, and use the
<code>this.template({...})</code> and <code>this.contract({...})</code> methods to specify
what contracts to deploy:</p>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// in your project&#x27;s api.ts:</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Deployment</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@fadroma/agent&#x27;</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeploymentA</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Deployment</span> {

  kv1 = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">contract</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;kv1&#x27;</span>,
    <span class="hljs-attr">crate</span>: <span class="hljs-string">&#x27;examples/kv&#x27;</span>,
    <span class="hljs-attr">initMsg</span>: {}
  })

  kv2 = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">contract</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;kv2&#x27;</span>,
    <span class="hljs-attr">crate</span>: <span class="hljs-string">&#x27;examples/kv&#x27;</span>,
    <span class="hljs-attr">initMsg</span>: {}
  })

}
</code></pre>
<h3 id="preparing" tabindex="-1">Preparing</h3>
<p>To prepare a deployment for deploying, use <code>getDeployment</code>.
This will provide a populated instance of your deployment class.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { getDeployment } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@hackbg/fadroma&#x27;</span>
deployment = <span class="hljs-title function_">getDeployment</span>(<span class="hljs-title class_">DeploymentA</span>, <span class="hljs-comment">/* ...constructor args */</span>)
</code></pre>
<h3 id="deploying-everything" tabindex="-1">Deploying everything</h3>
<p>Then, call its <code>deploy</code> method:</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">await</span> deployment.<span class="hljs-title function_">deploy</span>()
</code></pre>
<p>For each contract defined in the deployment, this will do the following:</p>
<ul>
<li>If it's not compiled yet, this will <strong>build</strong> it.</li>
<li>If it's not uploaded yet, it will <strong>upload</strong> it.</li>
<li>If it's not instantiated yet, it will <strong>instantiate</strong> it.</li>
</ul>
<h3 id="expecting-contracts-to-be-deployed" tabindex="-1">Expecting contracts to be deployed</h3>
<p>Having deployed a contract, you want to obtain a <code>Client</code> instance
that points to it, so you can call the contract's methods.</p>
<p>Using the <code>contract.expect()</code> method you can get an instance
of the <code>Client</code> specified in the contract options, provided
the contract is already deployed (i.e. its address is known).</p>
<pre><code class="hljs language-typescript"><span class="hljs-title function_">assert</span>(deployment.<span class="hljs-property">kv1</span>.<span class="hljs-title function_">expect</span>() <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Client</span>)
<span class="hljs-title function_">assert</span>(deployment.<span class="hljs-property">kv2</span>.<span class="hljs-title function_">expect</span>() <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Client</span>)
</code></pre>
<p>This is the recommended method for passing handles to contracts
to your UI code after deploying or connecting to a stored deployment
(see below).</p>
<p>If the address of the request contract is not available,
this will throw an error.</p>
<h3 id="deploying-individual-contracts-with-dependencies" tabindex="-1">Deploying individual contracts with dependencies</h3>
<p>By <code>await</code>ing a <code>Contract</code>'s <code>deployed</code> property, you say:
&quot;give me a handle to this contract; if it's not deployed,
deploy it, and all of its dependencies (as specified by the <code>initMsg</code> method)&quot;.</p>
<pre><code class="hljs language-typescript"><span class="hljs-title function_">assert</span>(<span class="hljs-keyword">await</span> deployment.<span class="hljs-property">kv1</span>.<span class="hljs-property">deployed</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Client</span>)
<span class="hljs-title function_">assert</span>(<span class="hljs-keyword">await</span> deployment.<span class="hljs-property">kv2</span>.<span class="hljs-property">deployed</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Client</span>)
</code></pre>
<p>Since this does not call the deployment's <code>deploy</code> method,
it <em>only</em> deploys the requested contract and its dependencies
but not any other contracts defined in the deployment.</p>
<h3 id="deploying-with-custom-logic" tabindex="-1">Deploying with custom logic</h3>
<p>The <code>deployment.deploy</code> method simply instantiates
all contracts in order. You are free to override it
and deploy the defined contracts according to some
custom logic:</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DeploymentB</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Deployment</span> {
  kv1 = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">contract</span>({ <span class="hljs-attr">crate</span>: <span class="hljs-string">&#x27;examples/kv&#x27;</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;kv1&#x27;</span>, <span class="hljs-attr">initMsg</span>: {} })
  kv2 = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">contract</span>({ <span class="hljs-attr">crate</span>: <span class="hljs-string">&#x27;examples/kv&#x27;</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;kv2&#x27;</span>, <span class="hljs-attr">initMsg</span>: {} })

  deploy = <span class="hljs-keyword">async</span> (<span class="hljs-attr">deployBoth</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">kv1</span>.<span class="hljs-property">deployed</span>
    <span class="hljs-keyword">if</span> (deployBoth) <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">kv2</span>.<span class="hljs-property">deployed</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>
  }
}
</code></pre>
<h3 id="storing-and-exporting-deployment-state" tabindex="-1">Storing and exporting deployment state</h3>
<p>By default, the list of contracts in each deployment created by Fadroma
is stored in <code>state/${CHAIN_ID}/deploy/${DEPLOYMENT}.yml</code>.</p>
<p>The deployment currently selected as &quot;active&quot; by the CLI
(usually, the latest created deployment) is symlinked at
<code>state/${CHAIN_ID}/deploy/.active.yml</code>.</p>
<h3 id="exporting-the-deployment" tabindex="-1">Exporting the deployment</h3>
<p>Deployments in YAML multi-document format are human-readable
and version control-friendly. When a list of contracts in JSON
is desired, you can use the <code>export</code> command to export a JSON
snapshot of the active deployment.</p>
<p>For example, to select and export a mainnet deployment:</p>
<pre><code class="hljs language-sh">pnpm mainnet select NAME
pnpm mainnet <span class="hljs-built_in">export</span> [DIRECTORY]
</code></pre>
<p>This will create a file named <code>NAME_@_TIMESTAMP.json</code>
in the current working directory (or another specified).</p>
<p>Internally, the data for the export is generated by the
<code>deployment.snapshot</code> getter:</p>
<pre><code class="hljs language-typescript">assert.<span class="hljs-title function_">deepEqual</span>(
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(deployment.<span class="hljs-property">snapshot</span>.<span class="hljs-property">contracts</span>),
  [<span class="hljs-string">&#x27;kv1&#x27;</span>, <span class="hljs-string">&#x27;kv2&#x27;</span>]
)
</code></pre>
<p>In a standard Fadroma project, where the Rust contracts
and TypeScript API client live in the same repo, by <code>export</code>ing
the latest mainnet and testnet deployments to JSON files
during the TypeScript build process, and adding them to your
API client package, you can publish an up-to-date &quot;address book&quot;
of your project's active contracts as part of your API client library.</p>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// in your project&#x27;s api.ts:</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Deployment</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@fadroma/agent&#x27;</span>

<span class="hljs-comment">// you would load snapshots as JSON, e.g.:</span>
<span class="hljs-comment">// const testnet = await (await fetch(&#x27;./testnet_v4.json&#x27;)).json()</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> mainnet = deployment.<span class="hljs-property">snapshot</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> testnet = deployment.<span class="hljs-property">snapshot</span>

<span class="hljs-comment">// and create instances of your deployment with preloaded</span>
<span class="hljs-comment">// &quot;address books&quot; of contracts. for example here we restore</span>
<span class="hljs-comment">// a different snapshot depending on whether we&#x27;re passed a</span>
<span class="hljs-comment">// mainnet or testnet connection.</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DeploymentC</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Deployment</span> {
  kv1 = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">contract</span>({ <span class="hljs-attr">crate</span>: <span class="hljs-string">&#x27;examples/kv&#x27;</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;kv1&#x27;</span>, <span class="hljs-attr">initMsg</span>: {} })
  kv2 = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">contract</span>({ <span class="hljs-attr">crate</span>: <span class="hljs-string">&#x27;examples/kv&#x27;</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;kv2&#x27;</span>, <span class="hljs-attr">initMsg</span>: {} })

  <span class="hljs-keyword">static</span> connect = <span class="hljs-function">(<span class="hljs-params">agent: Agent</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (agent?.<span class="hljs-property">chain</span>?.<span class="hljs-property">isMainnet</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">this</span>({ ...mainnet, agent })
    <span class="hljs-keyword">if</span> (agent?.<span class="hljs-property">chain</span>?.<span class="hljs-property">isTestnet</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">this</span>({ ...testnet, agent })
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">this</span>({ agent })
  }
}
</code></pre>
<h3 id="connecting-to-an-exported-deployment" tabindex="-1">Connecting to an exported deployment</h3>
<p>Having been deployed once, contracts may be used continously.
The <code>Deployment</code>'s <code>connect</code> method loads stored data about
the contracts in the deployment, populating the contained
<code>Contract</code> instances.</p>
<p>With the above setup you can automatically connect to
your project in mainnet or testnet mode, depending on
what <code>Agent</code> you pass:</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">const</span> mainnetAgent = { <span class="hljs-attr">chain</span>: { <span class="hljs-attr">isMainnet</span>: <span class="hljs-literal">true</span> } } <span class="hljs-comment">// mock</span>
<span class="hljs-keyword">const</span> testnetAgent = { <span class="hljs-attr">chain</span>: { <span class="hljs-attr">isTestnet</span>: <span class="hljs-literal">true</span> } } <span class="hljs-comment">// mock</span>

<span class="hljs-keyword">const</span> onMainnet = <span class="hljs-title class_">DeploymentC</span>.<span class="hljs-title function_">connect</span>(mainnetAgent)

<span class="hljs-keyword">const</span> onTestnet = <span class="hljs-title class_">DeploymentC</span>.<span class="hljs-title function_">connect</span>(testnetAgent)

<span class="hljs-title function_">assert</span>(onMainnet.<span class="hljs-property">isMainnet</span>)
<span class="hljs-title function_">assert</span>(onTestnet.<span class="hljs-property">isTestnet</span>)
assert.<span class="hljs-title function_">deepEqual</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(onMainnet.<span class="hljs-property">contracts</span>), [<span class="hljs-string">&#x27;kv1&#x27;</span>, <span class="hljs-string">&#x27;kv2&#x27;</span>])
assert.<span class="hljs-title function_">deepEqual</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(onTestnet.<span class="hljs-property">contracts</span>), [<span class="hljs-string">&#x27;kv1&#x27;</span>, <span class="hljs-string">&#x27;kv2&#x27;</span>])
</code></pre>
<p>Or, to connect to individual contracts from the stored deployment:</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">const</span> kv1 = <span class="hljs-title class_">DeploymentC</span>.<span class="hljs-title function_">connect</span>(mainnetAgent).<span class="hljs-property">kv1</span>.<span class="hljs-title function_">expect</span>()
<span class="hljs-title function_">assert</span>(kv1 <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Client</span>)

<span class="hljs-keyword">const</span> kv2 = <span class="hljs-title class_">DeploymentC</span>.<span class="hljs-title function_">connect</span>(testnetAgent).<span class="hljs-property">kv2</span>.<span class="hljs-title function_">expect</span>()
<span class="hljs-title function_">assert</span>(kv2 <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Client</span>)
</code></pre>
<h3 id="adding-custom-migrations" tabindex="-1">Adding custom migrations</h3>
<p>Migrations can be implemented as static or regular methods
of <code>Deployment</code> classes.</p>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// in your project&#x27;s api.ts:</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Deployment</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@fadroma/agent&#x27;</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DeploymentD</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">DeploymentC</span> {
  kv3 = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">contract</span>({ <span class="hljs-attr">crate</span>: <span class="hljs-string">&#x27;examples/kv&#x27;</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;kv3&#x27;</span>, <span class="hljs-attr">initMsg</span>: {} })

  <span class="hljs-comment">// simplest client-side migration is to just instantiate</span>
  <span class="hljs-comment">// a new deployment with the data from the old deployment.</span>
  <span class="hljs-keyword">static</span> upgrade = <span class="hljs-function">(<span class="hljs-params">previous: DeploymentC</span>) =&gt;</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title function_">this</span>({ ...previous })
}

<span class="hljs-comment">// simplest chain-side migration is to just call default deploy,</span>
<span class="hljs-comment">// which should reuse kv1 and kv2 and only deploy kv3.</span>
deployment = <span class="hljs-keyword">await</span> <span class="hljs-title class_">DeploymentD</span>.<span class="hljs-title function_">upgrade</span>(deployment).<span class="hljs-title function_">deploy</span>()
</code></pre>
<h2 id="template" tabindex="-1">Template</h2>
<p>The <code>Template</code> class represents a smart contract's source, compilation,
binary, and upload. It can have a <code>codeHash</code> and <code>codeId</code> but not an
<code>address</code>.</p>
<p><strong>Instantiating a template</strong> refers to calling the <code>template.instance</code>
method (or its plural, <code>template.instances</code>), which returns <code>Contract</code>,
which represents a particular smart contract instance, which can have
an <code>address</code>.</p>
<h3 id="deploying-multiple-contracts-from-a-template" tabindex="-1">Deploying multiple contracts from a template</h3>
<p>The <code>deployment.template</code> method adds a <code>Template</code> to the <code>Deployment</code>.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Deployment4</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Deployment</span> {

  t = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">template</span>({ <span class="hljs-attr">crate</span>: <span class="hljs-string">&#x27;examples/kv&#x27;</span> })

  a = <span class="hljs-variable language_">this</span>.<span class="hljs-property">t</span>.<span class="hljs-title function_">instance</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-attr">initMsg</span>: {} })

  b = <span class="hljs-variable language_">this</span>.<span class="hljs-property">t</span>.<span class="hljs-title function_">instances</span>([
    {<span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;b1&#x27;</span>,<span class="hljs-attr">initMsg</span>:{}},
    {<span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;b2&#x27;</span>,<span class="hljs-attr">initMsg</span>:{}},
    {<span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;b3&#x27;</span>,<span class="hljs-attr">initMsg</span>:{}}
  ])

  c = <span class="hljs-variable language_">this</span>.<span class="hljs-property">t</span>.<span class="hljs-title function_">instances</span>({
    <span class="hljs-attr">c1</span>:{<span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;c1&#x27;</span>,<span class="hljs-attr">initMsg</span>:{}},
    <span class="hljs-attr">c2</span>:{<span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;c2&#x27;</span>,<span class="hljs-attr">initMsg</span>:{}},
    <span class="hljs-attr">c3</span>:{<span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;c3&#x27;</span>,<span class="hljs-attr">initMsg</span>:{}}
  })

}
</code></pre>
<p>You can pass either an array or an object to <code>template.instances</code>.</p>
<pre><code class="hljs language-typescript">deployment = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDeployment</span>(<span class="hljs-title class_">Deployment4</span>).<span class="hljs-title function_">deploy</span>()
<span class="hljs-title function_">assert</span>(deployment.<span class="hljs-property">t</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Template</span>)

<span class="hljs-title function_">assert</span>([
  deployment.<span class="hljs-property">a</span>,
  ...<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(deployment.<span class="hljs-property">b</span>)
  ...<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(deployment.<span class="hljs-property">c</span>)
].<span class="hljs-title function_">every</span>(
  <span class="hljs-function"><span class="hljs-params">c</span>=&gt;</span>(c <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Contract</span>) &amp;&amp; (c.<span class="hljs-title function_">expect</span>() <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Client</span>)
))
</code></pre>
<h3 id="building-from-source-code" tabindex="-1">Building from source code</h3>
<p>To build, the <code>builder</code> property must be set to a valid <code>Builder</code>.
When obtaining instances from a <code>Deployment</code>, the <code>builder</code> property
is provided automatically from <code>deployment.builder</code>.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Builder</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@fadroma/agent&#x27;</span>
<span class="hljs-title function_">assert</span>(deployment.<span class="hljs-property">t</span>.<span class="hljs-property">builder</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Builder</span>)
assert.<span class="hljs-title function_">equal</span>(deployment.<span class="hljs-property">t</span>.<span class="hljs-property">builder</span>, deployment.<span class="hljs-property">builder</span>)
</code></pre>
<p>You can build a <code>Template</code> (or its subclass, <code>Contract</code>) by awaiting the
<code>built</code> property or the return value of the <code>build()</code> method.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">await</span> deployment.<span class="hljs-property">t</span>.<span class="hljs-property">built</span>
<span class="hljs-comment">// -or-</span>
<span class="hljs-keyword">await</span> deployment.<span class="hljs-property">t</span>.<span class="hljs-title function_">build</span>()
</code></pre>
<p>See <a href="./build.html">the <strong>build guide</strong></a> for more info.</p>
<h3 id="uploading-binaries" tabindex="-1">Uploading binaries</h3>
<p>To upload, the <code>uploader</code> property must be set to a valid <code>Uploader</code>.
When obtaining instances from a <code>Deployment</code>, the <code>uploader</code> property
is provided automatically from <code>deployment.uploader</code>.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Uploader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@fadroma/agent&#x27;</span>
<span class="hljs-title function_">assert</span>(deployment.<span class="hljs-property">t</span>.<span class="hljs-property">uploader</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Uploader</span>)
assert.<span class="hljs-title function_">equal</span>(deployment.<span class="hljs-property">t</span>.<span class="hljs-property">uploader</span>, deployment.<span class="hljs-property">uploader</span>)
</code></pre>
<p>You can upload a <code>Template</code> (or its subclass, <code>Contract</code>) by awaiting the
<code>uploaded</code> property or the return value of the <code>upload()</code> method.</p>
<p>If a WASM binary is not present (<code>template.artifact</code> is empty),
but a source and a builder are present, this will also try to build the contract.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">await</span> deployment.<span class="hljs-property">t</span>.<span class="hljs-property">uploaded</span>
<span class="hljs-comment">// -or-</span>
<span class="hljs-keyword">await</span> deployment.<span class="hljs-property">t</span>.<span class="hljs-title function_">upload</span>()
</code></pre>
<p>See <a href="./upload.html">the <strong>upload guide</strong></a> for more info.</p>
<h2 id="contract" tabindex="-1">Contract</h2>
<p>The <code>Contract</code> class describes an individual smart contract instance and uniquely identifies it
within the <code>Deployment</code>.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Contract</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@fadroma/agent&#x27;</span>

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Contract</span>({
  <span class="hljs-attr">repository</span>: <span class="hljs-string">&#x27;REPO&#x27;</span>,
  <span class="hljs-attr">revision</span>:   <span class="hljs-string">&#x27;REF&#x27;</span>,
  <span class="hljs-attr">workspace</span>:  <span class="hljs-string">&#x27;WORKSPACE&#x27;</span>
  <span class="hljs-attr">crate</span>:      <span class="hljs-string">&#x27;CRATE&#x27;</span>,
  <span class="hljs-attr">artifact</span>:   <span class="hljs-string">&#x27;ARTIFACT&#x27;</span>,
  <span class="hljs-attr">chain</span>:      { <span class="hljs-comment">/* ... */</span> },
  <span class="hljs-attr">agent</span>:      { <span class="hljs-comment">/* ... */</span> },
  <span class="hljs-attr">deployment</span>: { <span class="hljs-comment">/* ... */</span> },
  <span class="hljs-attr">codeId</span>:     <span class="hljs-number">0</span>,
  <span class="hljs-attr">codeHash</span>:   <span class="hljs-string">&#x27;CODEHASH&#x27;</span>
  <span class="hljs-attr">client</span>:     <span class="hljs-title class_">Client</span>,
  <span class="hljs-attr">name</span>:       <span class="hljs-string">&#x27;NAME&#x27;</span>,
  <span class="hljs-attr">initMsg</span>:    <span class="hljs-keyword">async</span> () =&gt; ({})
})
</code></pre>
<h3 id="naming-and-labels" tabindex="-1">Naming and labels</h3>
<p>The chain requires labels to be unique.
Labels generated by Fadroma are of the format <code>${deployment.name}/${contract.name}</code>.</p>
<h3 id="lazy-init" tabindex="-1">Lazy init</h3>
<p>The <code>initMsg</code> property of <code>Contract</code> can be a function returning the actual message.
This function is only called during instantiation, and can be used to generate init
messages on the fly, such as when passing the address of one contract to another.</p>
<h3 id="deploying-contract-instances" tabindex="-1">Deploying contract instances</h3>
<p>To instantiate a <code>Contract</code>, its <code>agent</code> property must be set to a valid <code>Agent</code>.
When obtaining instances from a <code>Deployment</code>, their <code>agent</code> property is provided
from <code>deployment.agent</code>.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Agent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@fadroma/agent&#x27;</span>
<span class="hljs-title function_">assert</span>(deployment.<span class="hljs-property">a</span>.<span class="hljs-property">agent</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Agent</span>)
assert.<span class="hljs-title function_">equal</span>(deployment.<span class="hljs-property">a</span>.<span class="hljs-property">agent</span>, deployment.<span class="hljs-property">agent</span>)
</code></pre>
<p>You can instantiate a <code>Contract</code> by awaiting the <code>deployed</code> property or the return value of the
<code>deploy()</code> method. Since distributed ledgers are append-only, deployment is an idempotent operation,
so the deploy will run only once and subsequent calls will return the same <code>Contract</code> with the
same <code>address</code>.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">await</span> deployment.<span class="hljs-property">a</span>.<span class="hljs-title function_">deploy</span>()
<span class="hljs-keyword">await</span> deployment.<span class="hljs-property">a</span>.<span class="hljs-property">deployed</span>
</code></pre>
<p>If <code>contract.codeId</code> is not set but either source code or a WASM binary is present,
this will try to upload and build the code first.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">await</span> deployment.<span class="hljs-property">a</span>.<span class="hljs-property">uploaded</span>
<span class="hljs-keyword">await</span> deployment.<span class="hljs-property">a</span>.<span class="hljs-title function_">upload</span>()

<span class="hljs-keyword">await</span> deployment.<span class="hljs-property">a</span>.<span class="hljs-property">built</span>
<span class="hljs-keyword">await</span> deployment.<span class="hljs-property">a</span>.<span class="hljs-title function_">build</span>()
</code></pre>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> assert <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;node:assert&#x27;</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;./Deploy.test.ts&#x27;</span>
</code></pre>
</content>
<nav class="ensuite-md-toc"><p><div class="table-of-contents"><ul><li><a href="#deployment">Deployment</a><ul><li><a href="#preparing">Preparing</a></li><li><a href="#deploying-everything">Deploying everything</a></li><li><a href="#expecting-contracts-to-be-deployed">Expecting contracts to be deployed</a></li><li><a href="#deploying-individual-contracts-with-dependencies">Deploying individual contracts with dependencies</a></li><li><a href="#deploying-with-custom-logic">Deploying with custom logic</a></li><li><a href="#storing-and-exporting-deployment-state">Storing and exporting deployment state</a></li><li><a href="#exporting-the-deployment">Exporting the deployment</a></li><li><a href="#connecting-to-an-exported-deployment">Connecting to an exported deployment</a></li><li><a href="#adding-custom-migrations">Adding custom migrations</a></li></ul></li><li><a href="#template">Template</a><ul><li><a href="#deploying-multiple-contracts-from-a-template">Deploying multiple contracts from a template</a></li><li><a href="#building-from-source-code">Building from source code</a></li><li><a href="#uploading-binaries">Uploading binaries</a></li></ul></li><li><a href="#contract">Contract</a><ul><li><a href="#naming-and-labels">Naming and labels</a></li><li><a href="#lazy-init">Lazy init</a></li><li><a href="#deploying-contract-instances">Deploying contract instances</a></li></ul></li></ul></div></p></nav>
</div>
</body>
</html>