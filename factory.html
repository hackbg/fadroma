<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Security-Policy" content="default-src 'self' http: https: ws: wss: 'unsafe-inline';">
<title>Rendered by Ensuite</title>
</head>
<body>
<style name="assets/fonts.css" type="text/css">/* inter-regular - latin */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  src: url('assets/fonts/inter-v8-latin-regular.eot'); /* IE9 Compat Modes */
  src: local(''),
       url('assets/fonts/inter-v8-latin-regular.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('assets/fonts/inter-v8-latin-regular.woff2') format('woff2'), /* Super Modern Browsers */
       url('assets/fonts/inter-v8-latin-regular.woff') format('woff'), /* Modern Browsers */
       url('assets/fonts/inter-v8-latin-regular.ttf') format('truetype'), /* Safari, Android, iOS */
       url('assets/fonts/inter-v8-latin-regular.svg#Inter') format('svg'); /* Legacy iOS */
}

/* inter-600 - latin */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 600;
  src: url('assets/fonts/inter-v8-latin-600.eot'); /* IE9 Compat Modes */
  src: local(''),
       url('assets/fonts/inter-v8-latin-600.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('assets/fonts/inter-v8-latin-600.woff2') format('woff2'), /* Super Modern Browsers */
       url('assets/fonts/inter-v8-latin-600.woff') format('woff'), /* Modern Browsers */
       url('assets/fonts/inter-v8-latin-600.ttf') format('truetype'), /* Safari, Android, iOS */
       url('assets/fonts/inter-v8-latin-600.svg#Inter') format('svg'); /* Legacy iOS */
}


</style>
<style name="ensuite/node_modules/highlight.js/styles/school-book.css" type="text/css">pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#3e5915;background:#f6f5b2}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#059}.hljs-subst{color:#3e5915}.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-bullet,.hljs-link,.hljs-section,.hljs-string,.hljs-symbol,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#2c009f}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#e60415}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-strong,.hljs-title,.hljs-type{font-weight:700}.hljs-emphasis{font-style:italic}</style>
<style name="assets/style.css" type="text/css">* { box-sizing: border-box; margin: 0; padding: 0; line-height: 1.5; }

body { color: #123; font-size: 16px; font-family: "Inter", sans-serif; }
body { background-color: #f0f0f0; background-image: url('assets/bg.svg'); background-repeat: repeat; }

body > header {
  text-align: center;
  max-width: 80rem;
  margin: 0 auto;
  padding: 2rem 2rem 1rem;
}
body > header { display: flex; flex-flow: row nowrap; justify-content: space-around; align-items: center; }
body > header .logo, .logo img { display: block; margin: 0; flex-shrink: 1; }
body > header .logo img { max-width: 16rem; max-height: 16rem; }
body > header .badges { margin-bottom: 1rem; }
body > header a.badge { display: inline-block; padding: 0.25rem 0.5rem; }

section { padding: 1em; }

footer { padding: 1em; }

a { text-decoration: none; }
a:hover { text-decoration: underline; }
a, a:focus, a:visited, a:active, a:hover { color: rgb(101, 179, 76) }

h1, h2, h3, h4 { font-weight: 600 }
h1 { font-size: 3em;     line-height: 3rem;   margin-bottom: 2rem;                     }
h2 { font-size: 1.75em;  line-height: 2rem;   margin-bottom: 1rem;   margin-top: 0;    }
h3 { font-size: 1.5rem;  line-height: 2rem;   margin-bottom: 1rem;                     }
h4 { font-size: 1.25em;  line-height: 1.5rem; margin-bottom: 0.5rem; margin-top: 2rem; }
h5 { font-size: 1.125em; line-height: 1.5rem; margin-bottom: 0.5rem; margin-top: 2rem; }

button, .button {
  display: inline-block;
  background: rgb(101, 179, 76);
  color: white;
  padding: 0 1em;
  margin: 1em 0;
  text-shadow: -1px -1px 0 black;
  box-shadow: 1px 1px 0 black;
}
a.button:focus, a.button:visited, a.button:active, a.button:hover {
  color: white;
}

th, td { text-align: left; vertical-align: top; }
th { padding-right: 5em }

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  flex-flow: row wrap;
  justify-content: center;
  max-width: 80rem;
  margin: 0 auto 3rem;
}

@media (max-width: 80rem) {
  .grid {
    display: flex;
    flex-flow: column nowrap;
  }
  .grid .feature {
    display: flex;
    flex-flow: row nowrap;
  }
  .grid .feature .links {
    flex-shrink: 0;
    width: 33%;
    margin: 0 0 0 2rem;
  }
  .table-of-contents {
    width: 1rem;
  }
}

@media (max-width: 48rem) {
  .grid .feature .links {
    width: 50%;
  }
}

.big-left { grid-column-start: 1; grid-column-end: 3; }
.big-center { grid-column-start: 2; grid-column-end: 4; }
.big-right { grid-column-start: 3; grid-column-end: 5; }
.big-all { grid-column-start: 1; grid-column-end: 5; }

.feature {
  padding: 1rem;
  margin: 1rem 0.5rem 0;
  border: 1px solid rgba(0,0,0,0.1);
  border-top-color: rgba(255,255,255,0.5);
  border-left-color: rgba(255,255,255,0.5);
  border-radius: 3px;
  box-shadow: 3px 3px 6px rgba(0,0,0,0.1);
  display: flex;
  flex-flow: column nowrap;
  background: #fff;
}

.feature .docs {
  font-weight: bold;
}

#features .feature {
  min-height: 10rem;
}

.left {
  text-align: left;
}
.center {
  text-align: center;
}

.feature .description {
  line-height: 1.5;
  font-size: 0.875rem;
}

code { font-size: 0.9375rem; }
code.inline, code.block { background: #0c5749; color: white; font-family: monospace; font-weight: bold; }
code.inline { display: inline-block; padding: 0.5rem 1rem; margin: 0 0.5rem; }
code.block {
  display: block;
  padding: 1rem;
  margin: 1rem auto;
  border-radius: 0.5rem;
  max-width: 40rem;
  line-height: 1rem;
}

.feature-logo {
  margin-bottom: 0.5rem;
  height:        5rem;
  width:         12rem;
  align-self:    center;
}

.tag {
  font-size: 0.8rem;
  background: #f5faf3;
  border: 1px solid #437733;
  color: #437733;
  display: inline-block;
  padding: 0.25rem 0.5rem;
  margin: 0.5rem 0 0;
  align-self: flex-start;
  border-radius: 3px;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.spacer {
  flex-grow:  1;
  min-height: 0.5rem;
}

pre, code {
  font-family: monospace;
}

p {
  line-height: 1.5rem;
  margin-top: 0;
  margin-bottom: 0.5rem;
}

svg.icon {
  width: 2rem;
  height: 2rem;
}
a > svg.icon {
  fill: rgb(101, 179, 76);
  width: 1.5rem;
  height: 1.5rem;
  line-height: 1rem;
  vertical-align: baseline;
  margin-right: 0.5rem;
  flex-shrink: 0;
}
.feature a.docs {
  display: flex;
  flex-flow: row nowrap;
  align-items: flex-start;
  font-weight: normal;
  text-decoration: none;
  padding: 0.5rem 0;
  cursor: default;
  color: #888;
}
.feature a.docs[href] {
  text-decoration: underline;
  color: rgb(67, 119, 51);
  cursor: pointer;
}

@keyframes hourglass {
  50%  { transform: rotateZ(0);      }
	100% { transform: rotateZ(180deg); }
}

svg.icon-todo {
  animation-name: hourglass;
  animation-duration: 3s;
  animation-delay: 1s;
  animation-iteration-count: infinite;
}

.links {
  display: flex;
  flex-flow: column nowrap;
}
.links > a {
  margin-right: 1rem;
  transition:
    padding-left 0.33s,
    margin-right 0.33s;
}
.links > a[href]:hover {
  padding-left: 0.5rem;
  margin-right: 0.5rem;
}
.feature pre {
  background: #eee;
  padding: 0.5rem;
  border-radius: 0.1rem;
  font-size: 0.875rem;
  font-weight: normal;
  margin-top: 1rem;
  color: #555;
}

/*.feature .links .icon { fill: #F46623 }*/

.feature.invert { background: rgb(67, 119, 51); color: white; }
.feature.invert * { color: white; fill: white; }
.feature.invert a.docs { color: white; }
.feature.invert a.docs[href] { text-decoration: underline; }

.feature.foss { background: #2e0056; color: white; }
.feature.foss * { color: white; fill:  white; }
.feature.foss a.docs { color: white; }

.icon-todo { fill: #aaa !important; }

#quick-start {
  text-align: center;
  flex-grow: 1;
}

.ensuite-md-rendered {
  /*background: white;*/
  /*display: block;*/
  /*max-width: 54rem;*/
  /*margin: 3rem auto 0 38%;*/
  /*padding: 3rem;*/
  /*box-shadow: 3px 3px 6px rgba(0,0,0,0.1)*/
  display: flex;
  flex-flow: row nowrap;
  justify-content: center;
}


.ensuite-md-content {
  background: white;
  padding:    5rem 3rem 2rem;
  box-shadow: 3px 3px 6px rgba(0,0,0,0.1);
  max-width:  54rem;
}

.ensuite-md-nav {}
.ensuite-md-nav ul { list-style: none; margin-top: 5rem; margin-right: 2rem; }
.ensuite-md-nav li a { display: inline-block; font-weight: bold; padding: 0.5rem 1rem; text-transform: uppercase; font-size: 0.9rem; line-height: 1rem }

.ensuite-md-toc {}
.ensuite-md-toc .table-of-contents { margin-top: 5rem; margin-left: 1rem; overflow: auto; }
.table-of-contents { overflow: auto }
.table-of-contents a { display: block; text-decoration: none; padding: 0.25rem 1.5rem 0.25rem }
.table-of-contents a:hover { text-decoration: underline 2px solid }
.table-of-contents li { margin: 0 0 }
.table-of-contents ul { font-weight: bold; margin-left: 0; list-style: none }
.table-of-contents ul ul { font-weight: normal; margin-left: 1em }


/*.ensuite-md-rendered .table-of-contents {*/
  /*position: fixed;*/
  /*top: 3rem;*/
  /*left: 0;*/
  /*bottom: 0;*/
  /*width: 38%;*/
  /*background: #476d3b;*/
  /*background: hsl(106 25% 25% / 1);*/
  /*color: white;*/
  /*padding: 1rem 0 2rem 1rem;*/
  /*border-right: 1px solid #888;*/
  /*display: flex;*/
  /*justify-content: flex-end;*/
/*}*/
.ensuite-md-rendered h2 { margin-top: 2.5rem; margin-bottom: 0.5rem; }
.ensuite-md-rendered h3 { margin-top: 1.5rem; margin-bottom: 0.5rem; }

ul { margin-left: 0; margin-bottom: 1em; }

p > code { font-weight: bold; color: #345 }
pre > code {
  display: block;
  border: 1px solid #888;
  padding: 0.5rem 1rem;
  margin-bottom: 1rem;
  background: rgba(255,255,255,0.5);
  box-shadow: 2px 2px 2px #888;
  overflow-x: auto;
  margin: 1rem -1rem;
}
pre > code.language-sh {
  background: #123;
  border-radius: 0;
  color: #fe0;
}
pre > code.language-typescript {
  background: #ffe;
  border-radius: 0.15rem;
}

.ensuite-md-header {
  z-index: 100;
  display: flex;
  flex-flow: row nowrap;
  justify-content: space-between;
  text-align: left;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 3rem;
  font-size: 1.5rem;
  line-height: 3rem;
  margin: 0;
  padding: 0 1rem;
  font-weight: bold;
  background: hsl(106 30% 33% / 1);
  color: white;
  width: 100%;
  max-width: 100%;
  font-weight: normal
}
.ensuite-md-separator {
  flex-grow: 1;
}
.ensuite-md-header a {
  color: white;
}
.ensuite-md-header .ensuite-md-title {
}
.ensuite-md-header .ensuite-md-link {
  font-size: 1rem;
  margin-left: 1rem;
}

.hljs-comment, .hljs-deletion, .hljs-meta, .hljs-quote {
  color: green;
}
.hljs.language-sh .hljs-built_in {
  color: inherit;
}
.hljs.language-sh .hljs-comment {
  color: tomato;
}

hr {
  margin: 1rem -1rem;
}
</style>
<header class="ensuite-md-header">
<a class="ensuite-md-title" href="/">The <strong>Fadroma</strong> Guide</a>
<div class="ensuite-md-separator"></div>
<a class="ensuite-md-link" href=/>Homepage</a>
<a class="ensuite-md-link" href=/guide.html>Documentation</a>
<a class="ensuite-md-link" href=https://github.com/hackbg/fadroma>Github</a>
<a class="ensuite-md-link" href=https://crates.io/search?q=fadroma>Crates.io</a>
<a class="ensuite-md-link" href=https://www.npmjs.com/search?q=fadroma>NPM</a>
<a class="ensuite-md-link" href=https://hack.bg/>Hack.bg</a>
</header>
<div class="ensuite-md-rendered">
<nav class="ensuite-md-nav"><ul>
<li><a class="ensuite-md-link" href=/guide.html>Getting started</a></li>
<li><a class="ensuite-md-link" href=/project.html>Projects</a></li>
<li><a class="ensuite-md-link" href=/agent.html>Agent API</a></li>
<li><a class="ensuite-md-link" href=/scrt.html>Secret Network</a></li>
<li><a class="ensuite-md-link" href=/dsl.html>Macro DSL</a></li>
<li><a class="ensuite-md-link" href=/build.html>Building</a></li>
<li><a class="ensuite-md-link" href=/upload.html>Uploading</a></li>
<li><a class="ensuite-md-link" href=/deploy.html>Deploy API</a></li>
<li><a class="ensuite-md-link" href=/factory.html>Factories</a></li>
<li><a class="ensuite-md-link" href=/devnet.html>Devnets</a></li>
<li><a class="ensuite-md-link" href=/mocknet.html>Mocknets</a></li>
</ul></nav>
<content class="ensuite-md-content"><div><p></div></p>
<h1 id="a-fadroma-pattern%3A-factory" tabindex="-1">A Fadroma Pattern: Factory</h1>
<h2 id="introduction" tabindex="-1">Introduction</h2>
<p>This is a common pattern that uses simple ICC (inter-contract communication) to let end users
instantiate contracts in a semi-controlled way: the &quot;factory&quot; contract determines the code of
the contract to instantiate, and callers can specify init parameters for the individual
&quot;product&quot; contract instances that they request from the factory. This factory also keeps track
of all contracts instantiated through it, and can be queried to provide a paginated list.</p>
<p>In the following example, there are two contracts involved, <code>Factory</code> and <code>Product</code>.
(For their code, see the <a href="https://github.com/hackbg/fadroma/tree/master/examples/factory"><code>factory</code></a>,
<a href="https://github.com/hackbg/fadroma/tree/master/examples/factory-product"><code>factory-product</code></a>,
and <a href="https://github.com/hackbg/fadroma/tree/master/examples/factory-shared"><code>factory-shared</code></a> crates
in the <a href="https://github.com/hackbg/fadroma/tree/master/examples"><code>examples/</code> directory of the Fadroma repo</a>)</p>
<p>The control flow goes something like this:</p>
<ul>
<li>Build and upload Factory and Product.</li>
<li>Instantiate a Factory, providing it with code id and code hash for Product.</li>
<li>User requests from the Factory to create a Product.</li>
<li>Factory instantiates a Product.</li>
<li>The Product calls back to factory to register itself.</li>
<li>That way, the Factory keeps track of all Products created through it.</li>
</ul>
<h2 id="defining-a-deployment-subclass" tabindex="-1">Defining a Deployment subclass</h2>
<p>Here's how this pattern can be described as a <code>Deployment</code> in your project's <code>api.ts</code> or similar.</p>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// api.ts</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Deployment</span>, <span class="hljs-title class_">Client</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@fadroma/agent&#x27;</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FactoryDeployment</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Deployment</span> {

  <span class="hljs-comment">// There will be an unlimited number of `Product` contracts</span>
  <span class="hljs-comment">// instantiated by the `Factory`. Let&#x27;s use `this.template`</span>
  <span class="hljs-comment">// to define the initial source code and final client class</span>
  <span class="hljs-comment">// for each one of them:</span>
  product = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">template</span>({
    <span class="hljs-attr">workspace</span>: <span class="hljs-string">&#x27;.&#x27;</span>,
    <span class="hljs-attr">crate</span>: <span class="hljs-string">&#x27;examples/factory-product&#x27;</span>,
    <span class="hljs-attr">client</span>: <span class="hljs-title class_">Product</span>
  })

  <span class="hljs-comment">// The `Factory`, on the other hand, is a single contract instance.</span>
  <span class="hljs-comment">// So, let&#x27;s use `this.contract` to provide its name and init message:</span>
  factory = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">contract</span>({
    <span class="hljs-attr">workspace</span>: <span class="hljs-string">&#x27;.&#x27;</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;factory&#x27;</span>,
    <span class="hljs-attr">crate</span>: <span class="hljs-string">&#x27;examples/factory&#x27;</span>,
    <span class="hljs-attr">client</span>: <span class="hljs-title class_">Factory</span>,
    <span class="hljs-attr">initMsg</span>: <span class="hljs-keyword">async</span> () =&gt; ({
      <span class="hljs-comment">// This `Factory` takes one configuration parameter, `code`,</span>
      <span class="hljs-comment">// which contains the code id and code hash needed to</span>
      <span class="hljs-comment">// instantiate `Product`s.</span>
      <span class="hljs-comment">//</span>
      <span class="hljs-comment">// Using `await this.product.uploaded` here makes sure that</span>
      <span class="hljs-comment">// instantiating a Factory will automatically upload the</span>
      <span class="hljs-comment">// `Product` template if it&#x27;s not uploaded yet.</span>
      <span class="hljs-comment">//</span>
      <span class="hljs-comment">// The `asContractCode` getter converts a `Template` into</span>
      <span class="hljs-comment">// the `ContractCode { id, code_hash }` struct that the</span>
      <span class="hljs-comment">// `Factory` expects.</span>
      <span class="hljs-attr">code</span>: (<span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">product</span>.<span class="hljs-property">uploaded</span>).<span class="hljs-property">asContractCode</span>
    })
  })

  <span class="hljs-comment">// Defining custom methods directly on the `Deployment`</span>
  <span class="hljs-comment">// lets you interact with the deployed multi-contract system</span>
  <span class="hljs-comment">// as a coherent whole.</span>
  <span class="hljs-comment">//</span>
  <span class="hljs-comment">// Here, `contract.expect()` makes the method call fail</span>
  <span class="hljs-comment">// if the `Factory` is not already instantiated. Otherwise,</span>
  <span class="hljs-comment">// it will return an instance of the `client` class specified</span>
  <span class="hljs-comment">// in the definition above.</span>
  <span class="hljs-comment">//</span>
  <span class="hljs-comment">// Having made sure that there is a contract to call, the</span>
  <span class="hljs-comment">// `factory.client` method is called. (This is defined on the</span>
  <span class="hljs-comment">// `Factory` client class below.)</span>
  create = <span class="hljs-function">(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) =&gt;</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">factory</span>.<span class="hljs-title function_">expect</span>().<span class="hljs-title function_">create</span>(name)

  <span class="hljs-comment">// Finally, here&#x27;s a getter which fetches the list of `Product`</span>
  <span class="hljs-comment">// instances that have been created so far.</span>
  <span class="hljs-comment">// Once again, we `expect` the factory to already exist,</span>
  <span class="hljs-comment">// and call the `factory.list` method (defined below).</span>
  <span class="hljs-comment">// We return all other info from the response unchanged,</span>
  <span class="hljs-comment">// only convert the array of plain `{ address, code_hash }`</span>
  <span class="hljs-comment">// structs returned by the contract into an array of</span>
  <span class="hljs-comment">// ready-to-use `Product` clients bound to `deployment.agent`</span>
  getProducts = <span class="hljs-function">() =&gt;</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">factory</span>.<span class="hljs-title function_">expect</span>().<span class="hljs-title function_">list</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">{entries, ...rest}</span>)=&gt;</span>({
      ...rest,
      <span class="hljs-attr">entries</span>: entries.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">{address,code_hash}</span>)=&gt;</span><span class="hljs-variable language_">this</span>.<span class="hljs-property">agent</span>.<span class="hljs-title function_">getClient</span>(
        <span class="hljs-title class_">Product</span>, address, code_hash
      ))
    }))

}

<span class="hljs-comment">// A `Client` class can be used to compose the actual JSON messages</span>
<span class="hljs-comment">// that are passed to the contract. You can also add metadata,</span>
<span class="hljs-comment">// validation, etc.</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Factory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Client</span> {

  create = <span class="hljs-function">(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) =&gt;</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">execute</span>({ <span class="hljs-attr">create</span>: { name } })

  list = <span class="hljs-function">(<span class="hljs-params">pagination = { start: <span class="hljs-number">0</span>, limit: <span class="hljs-number">100</span> }</span>) =&gt;</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">query</span>({ <span class="hljs-attr">list</span>: { pagination } })

}

<span class="hljs-comment">// An empty `Client` class is just a marker</span>
<span class="hljs-comment">// for what kind of contract it connects to.</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Client</span> {

  <span class="hljs-comment">// In practice, you would have your `Product`&#x27;s methods here -</span>
  <span class="hljs-comment">// for example, if your `Factory` instantiates AMM pools,</span>
  <span class="hljs-comment">// you could define add things like `swap` or `addLiquidity`.</span>

}
</code></pre>
<h2 id="integration-testing" tabindex="-1">Integration testing</h2>
<p>Here's how you would deploy and test the system described above,
using Fadroma's Mocknet and Devnet features to avoid cluttering the
public testnet with intermediate iterations.</p>
<p>The Mocknet uses JavaScript's built-in WebAssembly runtime
and a quick and dirty simulation of a CosmWasm environment, while
the Devnet launches a temporary <code>localsecret</code>-based container to
test your contracts on the real thing.</p>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// tes.ts</span>

<span class="hljs-comment">// import { FactoryDeployment } from &#x27;./api.ts&#x27;</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Chain</span>, getDeployment } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@hackbg/fadroma&#x27;</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">Scrt</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@fadroma/scrt&#x27;</span>
<span class="hljs-keyword">import</span> assert <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;node:assert&#x27;</span>

<span class="hljs-keyword">const</span> chains = [
  <span class="hljs-title class_">Chain</span>.<span class="hljs-property">variants</span>[<span class="hljs-string">&#x27;Mocknet&#x27;</span>](),
  <span class="hljs-title class_">Chain</span>.<span class="hljs-property">variants</span>[<span class="hljs-string">&#x27;ScrtDevnet&#x27;</span>]({ <span class="hljs-attr">deleteOnExit</span>: <span class="hljs-literal">true</span> }),
]

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> chain <span class="hljs-keyword">of</span> chains) {

  <span class="hljs-comment">// Get a populated instance of `FactoryDeployment`:</span>
  <span class="hljs-keyword">const</span> deployment = <span class="hljs-title function_">getDeployment</span>(<span class="hljs-title class_">FactoryDeployment</span>, {
    <span class="hljs-comment">// You need to provide an authenticated `Agent`:</span>
    <span class="hljs-attr">agent</span>: <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">getAgent</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Admin&#x27;</span> }).<span class="hljs-property">ready</span>
  })

  <span class="hljs-comment">// Deploy all contracts:</span>
  <span class="hljs-keyword">await</span> deployment.<span class="hljs-title function_">deploy</span>()

  <span class="hljs-comment">// In our case, the above will build+upload+instantiate `Factory`</span>
  <span class="hljs-comment">// (because it&#x27;s defined with `deployment.contract`), and it will</span>
  <span class="hljs-comment">// only build+upload `Product` (because it&#x27;s defined with</span>
  <span class="hljs-comment">// `deployment.template`).</span>

  <span class="hljs-comment">// Smoke check: in the initial state of the deployment,</span>
  <span class="hljs-comment">// the `products` getter should return zero things:</span>
  assert.<span class="hljs-title function_">deepEqual</span>(
    <span class="hljs-keyword">await</span> deployment.<span class="hljs-title function_">getProducts</span>(),
    { <span class="hljs-attr">total</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">entries</span>: [] },
    <span class="hljs-string">&#x27;factory starts out empty&#x27;</span>
  )

  <span class="hljs-comment">// Let&#x27;s instantiate a `Product` now:</span>
  <span class="hljs-keyword">await</span> deployment.<span class="hljs-title function_">create</span>(<span class="hljs-string">&#x27;foo&#x27;</span>)

  <span class="hljs-comment">// And make sure that the `products` getter converts</span>
  <span class="hljs-comment">// all returned values to `Product` client instances.</span>
  <span class="hljs-keyword">const</span> products = <span class="hljs-keyword">await</span> deployment.<span class="hljs-title function_">getProducts</span>()
  <span class="hljs-title function_">assert</span>(
    products.<span class="hljs-property">entries</span>.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">entry</span>=&gt;</span>entry <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Product</span>),
    <span class="hljs-string">&#x27;factory tracks products; deployment returns them as Product instances&#x27;</span>
  )

}
</code></pre>
<h2 id="deploying" tabindex="-1">Deploying</h2>
<p>From a script, you can use the <code>deploy</code> method of your <code>Deployment</code> class
to deploy, as shown in the testing section.</p>
<p>In the project structure created by <code>fadroma create</code>, your <code>Deployment</code>
class is also hooked up via your <code>Project</code> class in <code>ops.ts</code> to NPM scripts,
allowing you to deploy from the terminal like this:</p>
<pre><code class="hljs language-sh">npm run mainnet deploy
npm run testnet deploy
npm run devnet deploy
npm run mocknet deploy
</code></pre>
<h2 id="exporting-and-connecting" tabindex="-1">Exporting and connecting</h2>
<p>After validating a successful deployment to mainnet or testnet,
exporting a list of contracts makes it possible to find and connect to
your deployment from outside the deploy script - e.g. from a dApp frontend,
a backend service, or a third-party script.</p>
<p>You can export JSON snapshots of your deployment using the <code>fadroma export</code>
command, or manually by serializing the <code>deployment.snapshot</code> property.
By including those snapshots in your project's API client library, you
can allow users to easily connect to your official mainnet and testnet deployments.</p>
<p>Reconstructing a deployment from a snapshot can look like this:</p>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// some-downstream.ts</span>

<span class="hljs-comment">// import FactoryDeployment, { mainnetState, testnetState } from &#x27;@some/project&#x27;</span>

<span class="hljs-keyword">const</span> mainnetState = {<span class="hljs-comment">/* ... */</span>} <span class="hljs-comment">// mock</span>
<span class="hljs-keyword">const</span> testnetState = {<span class="hljs-comment">/* ... */</span>} <span class="hljs-comment">// mock</span>

<span class="hljs-keyword">const</span> mainnet = <span class="hljs-literal">true</span> <span class="hljs-comment">// process.env.MAINNET, or a toggle in your UI, etc.</span>
<span class="hljs-keyword">const</span> chain = mainnet ? <span class="hljs-string">&#x27;ScrtMainnet&#x27;</span> : <span class="hljs-string">&#x27;ScrtTestnet&#x27;</span>
<span class="hljs-keyword">const</span> state = mainnet ? mainnetState : testnetState
<span class="hljs-keyword">const</span> agent = <span class="hljs-title class_">Chain</span>.<span class="hljs-property">variants</span>[chain]().<span class="hljs-title function_">getAgent</span>({<span class="hljs-comment">/* mnemonic: &#x27;...&#x27; */</span>})
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FactoryDeployment</span>({ ...state, agent })
</code></pre>
<p>Here's a nice way to simplify that even further, for the users of your API client:
define &quot;connect&quot; entrypoints - either as functions (as show below):</p>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// api.ts</span>

<span class="hljs-comment">// import * as mainnetState from &#x27;./mainnet-snapshot.json&#x27;</span>
<span class="hljs-comment">// import * as testnetState from &#x27;./testnet-snapshot.json&#x27;</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> connectToFactory = {
  <span class="hljs-attr">onMainnet</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-function">(<span class="hljs-params">mnemonic: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FactoryDeployment</span>({
    ...mainnetState,
    <span class="hljs-attr">agent</span>: <span class="hljs-title class_">Chain</span>.<span class="hljs-property">variants</span>[<span class="hljs-string">&#x27;ScrtMainnet&#x27;</span>]().<span class="hljs-title function_">getAgent</span>({ mnemonic })
  }),
  <span class="hljs-attr">onTestnet</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-function">(<span class="hljs-params">mnemonic: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FactoryDeployment</span>({
    ...testnetState,
    <span class="hljs-attr">agent</span>: <span class="hljs-title class_">Chain</span>.<span class="hljs-property">variants</span>[<span class="hljs-string">&#x27;ScrtTestnet&#x27;</span>]().<span class="hljs-title function_">getAgent</span>({ mnemonic })
  })
}
</code></pre>
<p>or as static methods:</p>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// api.ts</span>

<span class="hljs-comment">// import * as mainnetState from &#x27;./mainnet-snapshot.json&#x27;</span>
<span class="hljs-comment">// import * as testnetState from &#x27;./testnet-snapshot.json&#x27;</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">imagine_this_is_FactoryDeployment</span> {
  <span class="hljs-comment">// ... the rest of your Deployment class ...</span>
  <span class="hljs-keyword">static</span> mainnet = <span class="hljs-function">() =&gt;</span> <span class="hljs-function">(<span class="hljs-params">mnemonic: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FactoryDeployment</span>({
    ...mainnetState,
    <span class="hljs-attr">agent</span>: <span class="hljs-title class_">Chain</span>.<span class="hljs-property">variants</span>[<span class="hljs-string">&#x27;ScrtMainnet&#x27;</span>].<span class="hljs-title function_">getAgent</span>({ mnemonic })
  })
  <span class="hljs-keyword">static</span> testnet = <span class="hljs-function">() =&gt;</span> <span class="hljs-function">(<span class="hljs-params">mnemonic: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FactoryDeployment</span>({
    ...testnetState,
    <span class="hljs-attr">agent</span>: <span class="hljs-title class_">Chain</span>.<span class="hljs-property">variants</span>[<span class="hljs-string">&#x27;ScrtTestnet&#x27;</span>].<span class="hljs-title function_">getAgent</span>({ mnemonic })
  })
  <span class="hljs-comment">// ... the rest of your Deployment class ...</span>
}
</code></pre>
<p>Furthermore: you may have noticed that the <code>FactoryDeployment</code> definition
uses the arrow syntax to define methods. This allows users of your API
client library to directly destructure a <code>FactoryDeployment</code> instance,
and get nice free-standing functions that represent the relevant actions
from your business logic:</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">const</span> { getProducts, createProduct } = connectToFactory.<span class="hljs-title function_">onMainnet</span>(<span class="hljs-comment">/*&#x27;mnemonic&#x27;*/</span>)
<span class="hljs-comment">// await getProducts()</span>
<span class="hljs-comment">// await createProduct(&#x27;...&#x27;)</span>
<span class="hljs-comment">// et cetera.</span>
</code></pre>
<h2 id="conclusion" tabindex="-1">Conclusion</h2>
<p>This concludes the Fadroma Factory Pattern example, which demonstrates
the main client-side features of Fadroma.</p>
<p>You've just seen how Fadroma can simplify and automate the fiddly
manual task of deploying multiple interconnected smart contracts,
reducing it to simple declarative programming and taking care of
all the steps behind the scenes.</p>
<p>In the future, we hope to expand this functionality to other
Cosmos-compatible chains, and allow deploying contracts across
multiple chains from the same unified definition.</p>
<p>For now, we hope that this abstraction expands your horizons about
all the exciting and novel things that you can build on the distributed
compute backend of the <a href="https://scrt.network">Secret Network</a>.</p>
<h2 id="see-also" tabindex="-1">See also</h2>
<ul>
<li><a href="./agent.html">Fadroma Agent API</a> reference</li>
<li><a href="./deploy.html">Fadroma Deploy API</a> reference</li>
<li><a href="https://github.com/hackbg/fadroma/tree/master/examples/factory">Example factory contract</a></li>
<li><a href="https://github.com/hackbg/fadroma/tree/master/examples/factory-product">Example product contract</a></li>
<li><a href="https://github.com/hackbg/fadroma/tree/master/examples/factory-shared">Example factory/product shared interface library</a></li>
</ul>
</content>
<nav class="ensuite-md-toc"><p><div class="table-of-contents"><ul><li><a href="#introduction">Introduction</a></li><li><a href="#defining-a-deployment-subclass">Defining a Deployment subclass</a></li><li><a href="#integration-testing">Integration testing</a></li><li><a href="#deploying">Deploying</a></li><li><a href="#exporting-and-connecting">Exporting and connecting</a></li><li><a href="#conclusion">Conclusion</a></li><li><a href="#see-also">See also</a></li></ul></div></p></nav>
</div>
</body>
</html>